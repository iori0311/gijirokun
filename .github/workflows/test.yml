name: Database Tests

on:
  pull_request:
    branches: [ main ]
    paths:
      - 'supabase/**'
      - 'tests/**'

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Setup Supabase CLI
        uses: supabase/setup-cli@v1
        with:
          version: latest

      - name: Start Supabase local development setup
        run: supabase start

      - name: Run database migrations
        run: |
          # ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã®å®Ÿè¡Œï¼ˆè‡ªå‹•ã§å®Ÿè¡Œã•ã‚Œã‚‹ã¯ãšï¼‰
          supabase db reset

      - name: Run database tests
        id: run-tests
        run: |
          # ãƒ†ã‚¹ãƒˆçµæœã‚’ä¿å­˜ã™ã‚‹ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ä½œæˆ
          mkdir -p test_results

          # ã‚·ãƒ¼ãƒ‰ãƒ‡ãƒ¼ã‚¿ã®æŠ•å…¥
          PGPASSWORD=postgres psql -h localhost -p 54322 -U postgres -d postgres -f supabase/seed.sql

          # ãƒ†ã‚¹ãƒˆå®Ÿè¡Œçµæœã‚’å¤‰æ•°ã«ä¿å­˜
          test_status=0

          echo "Running CRUD tests..."
          PGPASSWORD=postgres psql -h localhost -p 54322 -U postgres -d postgres -f tests/integration/db/crud.test.sql > test_results/crud.txt 2>&1
          if [ $? -ne 0 ]; then test_status=1; fi
          
          echo "Running RLS tests..."
          PGPASSWORD=postgres psql -h localhost -p 54322 -U postgres -d postgres -f tests/integration/db/rls.test.sql > test_results/rls.txt 2>&1
          if [ $? -ne 0 ]; then test_status=1; fi
          
          echo "Running constraints tests..."
          PGPASSWORD=postgres psql -h localhost -p 54322 -U postgres -d postgres -f tests/integration/db/constraints.test.sql > test_results/constraints.txt 2>&1
          if [ $? -ne 0 ]; then test_status=1; fi

          # ãƒ†ã‚¹ãƒˆçµæœã‚’outputã¨ã—ã¦ä¿å­˜
          echo "test_status=$test_status" >> $GITHUB_OUTPUT
          exit $test_status

      - name: Post test results
        if: always()
        uses: actions/github-script@v6
        with:
          script: |
            const fs = require('fs');
            const testStatus = process.env.TEST_STATUS === '0' ? 'âœ… æˆåŠŸ' : 'âŒ å¤±æ•—';
            
            // ãƒ†ã‚¹ãƒˆçµæœã‚’èª­ã¿è¾¼ã‚€
            const crudResults = fs.readFileSync('test_results/crud.txt', 'utf8');
            const rlsResults = fs.readFileSync('test_results/rls.txt', 'utf8');
            const constraintsResults = fs.readFileSync('test_results/constraints.txt', 'utf8');
            
            // ãƒãƒ¼ã‚¯ãƒ€ã‚¦ãƒ³å½¢å¼ã§ã‚³ãƒ¡ãƒ³ãƒˆã‚’ä½œæˆ
            const body = `## ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒ†ã‚¹ãƒˆçµæœ ğŸ”
            
            **ãƒ†ã‚¹ãƒˆçµæœ: ${testStatus}**

            ### 1. CRUDæ“ä½œãƒ†ã‚¹ãƒˆ
            \`\`\`sql
            ${crudResults}
            \`\`\`

            ### 2. RLSãƒãƒªã‚·ãƒ¼ãƒ†ã‚¹ãƒˆ
            \`\`\`sql
            ${rlsResults}
            \`\`\`

            ### 3. åˆ¶ç´„ãƒ†ã‚¹ãƒˆ
            \`\`\`sql
            ${constraintsResults}
            \`\`\`
            `;
            
            // PRã«ã‚³ãƒ¡ãƒ³ãƒˆã‚’æŠ•ç¨¿
            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });
        env:
          TEST_STATUS: ${{ steps.run-tests.outputs.test_status }}

      - name: Stop Supabase local development setup
        if: always()
        run: supabase stop 